{% extends "base.html" %} {%block title %}Chat{% endblock %} {% block extra_css
%}
<link rel="stylesheet" href="/static/css/style.css" />
{% endblock %} {% block content %}

 
    <!-- Conteúdo Principal -->
    <div class="main-content">
      <div class="container">
        <span class="beta-tag">beta</span>
        <h1>Converse com a Aurora</h1>
        <p class="description">
         Sou a Aurora, uma Inteligência Artificial desenvolvida a partir de fontes acadêmicas e científicas em Astronomia e Geofísica.
         Meu objetivo é responder exclusivamente a questões relacionadas a esses campos de estudo, fornecendo informações precisas e confiáveis.
        </p>

        <div id="chat-history"></div>
        <div class="input-area">
          <input
            type="text"
            id="user-input"
            placeholder="Digite sua mensagem ..."
          />
          <button id="send-button">
            <span class="material-symbols-rounded"> send </span>
          </button>
        </div>
        <p class="advice">
          Aurora é uma inteligência artificial e pode cometer erros.
        </p>
      </div>
    </div>
  </div>
  <script src="/static/js/chat.js"></script>
  <script>
    const chatHistory = document.getElementById("chat-history");
    const userInput = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");

    let conversationHistory = [
      {
        role: "system",
        content:
          "Olá! Eu sou a Aurora, uma jovem pesquisadora apaixonada por astronomia e geofísica. Respondo com no máximo 3 frases, de forma clara e objetiva. Só respondo perguntas relacionadas a ciência, especialmente astronomia e geofísica. Perguntas sobre política, religião, esportes, sexo ou qualquer tema sensível devem ser recusadas educadamente, com uma breve explicação e sem aprofundar. Evite explicações longas. Sempre mantenha o foco científico.",
      },
    ];

    sendButton.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") sendMessage();
    });

    async function playAudioStream(audioFiles) {
      try {
        const response = await fetch("/stream-audio", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ audio_files: audioFiles }),
        });

        if (!response.ok || !response.body) {
          console.error("Falha no streaming do áudio");
          return;
        }

        const audioContext = new AudioContext();
        const reader = response.body.getReader();

        let receivedLength = 0; // total bytes recebidos
        let chunks = [];

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          chunks.push(value);
          receivedLength += value.length;
        }

        // Combinar todos os chunks em um único Uint8Array
        let audioBuffer = new Uint8Array(receivedLength);
        let position = 0;
        for (let chunk of chunks) {
          audioBuffer.set(chunk, position);
          position += chunk.length;
        }

        // Decodificar e tocar
        const decodedData = await audioContext.decodeAudioData(
          audioBuffer.buffer
        );
        const source = audioContext.createBufferSource();
        source.buffer = decodedData;
        source.connect(audioContext.destination);
        source.start();
      } catch (error) {
        console.error("Erro ao tocar áudio em streaming:", error);
      }
    }

    function appendLoader() {
      const loaderElement = document.createElement("div");
      loaderElement.className = "message assistant-message loader-message";
      loaderElement.innerHTML = `
          <img src="/static/images/LogoAurora.png" alt="Aurora" class="profile-pic pulse-avatar">
          <div class="loading-dots">
            <span></span><span></span><span></span>
         </div> `;

      chatHistory.appendChild(loaderElement);
      chatHistory.scrollTop = chatHistory.scrollHeight;

      return loaderElement; // retorna o elemento para poder remover depois
    }

    function appendMessage(sender, message, className) {
      const messageElement = document.createElement("div");
      messageElement.className = `message ${className}`;

      if (className === "assistant-message") {
        messageElement.innerHTML = `
            <img src="/static/images/LogoAurora.png" alt="Assistente" class="profile-pic">
            <div class="message-content">
            <strong>${sender}:</strong> ${message}
          </div> `;
      } else {
        messageElement.innerHTML = `${message}`;
      }

      chatHistory.appendChild(messageElement);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      appendMessage("Você", message, "user-message");
      userInput.value = "";

      // Mostra o loader
      const loaderElement = appendLoader();

      axios
        .post("/chat", {
          user_input: message,
          conversation_history: conversationHistory,
        })
        .then(async function (response) {
          const data = response.data;
          const assistantResponse = data.response;
          conversationHistory = data.conversation_history;

          // Remove o loader
          loaderElement.remove();

          // Mostra a mensagem da Aurora
          appendMessage("Aurora", assistantResponse, "assistant-message");

          if (data.audio_files && data.audio_files.length > 0) {
            await playAudioStream(data.audio_files);
          }
        })
        .catch(function (error) {
          console.error("Erro:", error);
          loaderElement.remove();
          appendMessage(
            "Erro",
            "Ocorreu um erro ao processar sua solicitação.",
            "assistant-message"
          );
        });
    }
  </script>
  {% endblock %}

